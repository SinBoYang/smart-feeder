<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å¯µç‰©é¤µé£Ÿå™¨</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #eceff1; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 480px; }
        
        /* å½±ç‰‡å€ */
        .video-box img { width: 100%; border-radius: 5px; border: 2px solid #37474f; }
        
        /* æ•¸æ“šé¡¯ç¤º */
        .data-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .data-label { color: #546e7a; font-weight: bold; }
        .data-val { color: #263238; font-weight: bold; }
        
        /* é‡é»æ•¸æ“š */
        .big-name { font-size: 2em; color: #0277bd; text-align: center; margin: 10px 0; }
        .highlight { color: #d81b60; font-size: 1.2em; }
        
        /* è£œæ–™å»ºè­°å€ (æ©˜è‰²) */
        .feed-advice { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 5px solid #ff9800; }
        .advice-text { font-size: 1.1em; color: #e65100; font-weight: bold; }

        /* æŒ‰éˆ• */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; margin: 5px; }
        .start { background: #43a047; }
        .stop { background: #e53935; }
        .upload { background: #1e88e5; }
        
        input { padding: 8px; width: 70%; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
        #reg-area { display: none; background: #e3f2fd; padding: 15px; margin-top: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<h1 style="text-align: center; color: #37474f;">ğŸ• AI æ™ºæ…§è£œæ–™ç³»çµ±</h1>

<div class="container">
    <div class="card">
        <h3>ğŸ“¹ å³æ™‚ç›£æ§</h3>
        <div class="video-box">
            <img src="{{ url_for('video_feed') }}">
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <p>ç³»çµ±ç‹€æ…‹: <span id="st-text" style="font-weight:bold;">---</span></p>
            <button class="btn start" onclick="setSys('start')">å•Ÿå‹•</button>
            <button class="btn stop" onclick="setSys('stop')">åœæ­¢</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š é¤µé£Ÿæ•¸æ“šåˆ†æ</h3>
        
        <div class="big-name" id="disp-name">---</div>
        
        <div class="data-row">
            <span class="data-label">ç›®å‰é«”é‡:</span>
            <span class="data-val" id="disp-p-weight">---</span>
        </div>
        <div class="data-row">
            <span class="data-label">AI åˆ¤æ–·å“ç¨®:</span>
            <span class="data-val" id="disp-breed">---</span>
        </div>
        <div class="data-row">
            <span class="data-label">æ‡‰é¤µç›®æ¨™ (2%):</span>
            <span class="data-val" id="disp-target">0.000</span> kg
        </div>
        <div class="data-row">
            <span class="data-label">ç¢—å…§ç›®å‰:</span>
            <span class="data-val highlight" id="disp-bowl">0.000</span> kg
        </div>

        <div class="feed-advice" id="advice-box" style="display: none;">
            <div>âš ï¸ æœªé”æ¨™ï¼é‚„å·® <span id="disp-missing">0.000</span> kg</div>
            <div class="advice-text">
                ğŸ‘‰ å»ºè­°è£œæ–™ï¼š<span id="disp-sec" style="font-size: 1.5em;">0.0</span> ç§’
            </div>
            <small>(è¨ˆç®—åŸºæº–: æµé€Ÿ 0.05kg/ç§’)</small>
        </div>
        
        <div id="full-msg" style="text-align: center; color: green; font-weight: bold; margin-top: 15px; display: none;">
            âœ… ä»½é‡å……è¶³ï¼Œç„¡éœ€è£œæ–™
        </div>

        <hr>
        <h3>ğŸ“ è¨»å†Šæ–°å¯µç‰©</h3>
        <p>ä¸Šå‚³ç…§ç‰‡åˆ†æå¾Œï¼Œå³å¯è¼¸å…¥åå­—èˆ‡é«”é‡ã€‚</p>
        <input type="file" id="p-file" accept="image/*">
        <button class="btn upload" onclick="doUp()">ä¸Šå‚³ä¸¦åˆ†æ</button>
        
        <div id="reg-area">
            <h4>åˆ†ææˆåŠŸï¼å“ç¨®: <span id="reg-br" style="color:#1565c0;"></span></h4>
            <label>åå­—:</label><br>
            <input type="text" id="rn" placeholder="ä¾‹å¦‚: å°ç™½"><br>
            <label>é«”é‡ (kg):</label><br>
            <input type="number" id="rw" step="0.1" placeholder="ä¾‹å¦‚: 5.0"><br>
            <button class="btn start" style="width: 100%" onclick="doSave()">å„²å­˜è³‡æ–™</button>
        </div>
    </div>
</div>

<script>
    let tempBid = null;
    let tempBname = "";

    // å®šæ™‚æ›´æ–°ç‹€æ…‹
    setInterval(() => {
        fetch('/status').then(r => r.json()).then(d => {
            // 1. åŸºæœ¬è³‡è¨Šæ›´æ–°
            document.getElementById('st-text').innerText = d.msg;
            document.getElementById('st-text').style.color = d.running ? "green" : "red";
            document.getElementById('disp-name').innerText = d.pet_name;
            document.getElementById('disp-p-weight').innerText = d.pet_weight;
            document.getElementById('disp-breed').innerText = d.breed_info;
            document.getElementById('disp-target').innerText = d.target_feed;
            document.getElementById('disp-bowl').innerText = d.weight;

            // 2. åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œè£œæ–™å»ºè­°ã€
            // æ¢ä»¶ï¼šç³»çµ±é‹ä½œä¸­ + æœ‰åµæ¸¬åˆ°ç‹— (ç›®æ¨™>0)
            if (d.running && parseFloat(d.target_feed) > 0) {
                let missing = parseFloat(d.missing_weight);
                
                if (missing > 0) {
                    // éœ€è¦è£œæ–™
                    document.getElementById('advice-box').style.display = 'block';
                    document.getElementById('full-msg').style.display = 'none';
                    document.getElementById('disp-missing').innerText = d.missing_weight;
                    document.getElementById('disp-sec').innerText = d.supplement_seconds;
                } else {
                    // åƒé£½äº†
                    document.getElementById('advice-box').style.display = 'none';
                    document.getElementById('full-msg').style.display = 'block';
                }
            } else {
                // æ²’é–‹ç³»çµ±æˆ–æ²’ç‹—
                document.getElementById('advice-box').style.display = 'none';
                document.getElementById('full-msg').style.display = 'none';
            }
        });
    }, 1000);

    // é–‹é—œç³»çµ±
    function setSys(a) { 
        let fd = new FormData(); fd.append('action', a); 
        fetch('/set_system', {method:'POST', body:fd}); 
    }

    // ä¸Šå‚³ç…§ç‰‡
    function doUp() {
        let f = document.getElementById('p-file').files[0];
        if(!f) return alert("è«‹å…ˆé¸æ“‡ç…§ç‰‡æª”æ¡ˆï¼");
        
        let fd = new FormData(); fd.append('photo', f);
        fetch('/analyze_photo', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
            if(d.success){
                document.getElementById('reg-area').style.display='block';
                document.getElementById('reg-br').innerText = d.breed_name;
                tempBid = d.breed_id; tempBname = d.breed_name;
                if(!d.is_dog) alert("æé†’: é€™å¼µç…§ç‰‡ AI è¦ºå¾—ä¸åƒç‹—å–”ï¼");
            } else {
                alert("éŒ¯èª¤: " + d.msg);
            }
        });
    }

    // å„²å­˜è³‡æ–™
    function doSave() {
        let n = document.getElementById('rn').value;
        let w = document.getElementById('rw').value;
        if(!n||!w) return alert("åå­—å’Œé«”é‡éƒ½è¦å¡«å¯«ï¼");
        
        let fd = new FormData(); fd.append('name',n); fd.append('weight',w);
        fd.append('breed_id', tempBid); fd.append('breed_name', tempBname);
        
        fetch('/save_pet', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
            if(d.success) { 
                alert("è¨»å†ŠæˆåŠŸï¼"); 
                document.getElementById('reg-area').style.display='none'; 
                document.getElementById('rn').value = '';
                document.getElementById('rw').value = '';
                document.getElementById('p-file').value = '';
            } else {
                alert("å„²å­˜å¤±æ•—: " + d.msg);
            }
        });
    }
</script>

</body>
</html>
